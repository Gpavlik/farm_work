<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>–§–æ—Ä–º–∞ –Ω–∞–≤—á–∞–ª—å–Ω–æ–≥–æ –∑–∞–≤–¥–∞–Ω–Ω—è</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 2rem; background: #f9f9f9; }
    label, select, input, button { display: block; margin: 10px 0; width: 300px; }
    #productDropdown { border: 1px solid #ccc; padding: 10px; max-height: 200px; overflow-y: auto; background: #fff; }
    .hidden { display: none; }
  </style>
</head>
<body>

<h2>–§–æ—Ä–º–∞ –Ω–∞–≤—á–∞–ª—å–Ω–æ–≥–æ –∑–∞–≤–¥–∞–Ω–Ω—è</h2>

<div id="currentUser" style="display:none">–ê–Ω—Ç–æ–Ω—ñ–Ω–∞ –û–Ω–∏—â—É–∫</div>

<form id="trainingForm">
  <label for="managerSelect">–ú–µ–Ω–µ–¥–∂–µ—Ä:</label>
  <select id="managerSelect"></select>

  <label for="employeeSelect">–°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫:</label>
  <select id="employeeSelect"></select>

  <label for="skill">–ù–∞–≤–∏–∫:</label>
  <input id="skill" value="–ü–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–µ—Ç–∏ –ø–æ SMART" required />

  <label>–ü—Ä–æ–¥—É–∫—Ç–∏:</label>
  <button type="button" id="dropdownToggle">–û–±–µ—Ä—ñ—Ç—å –ø—Ä–æ–¥—É–∫—Ç–∏ ‚ñº</button>
  <div id="productDropdown" class="hidden"></div>
  <input type="hidden" id="selectedProducts" />

  <label>–î–µ–¥–ª–∞–π–Ω:</label>
  <input type="date" id="deadline" readonly />

  <button type="submit">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è</button>
</form>

<script>
const users = {
  "a.onischuk@pharmasco.com": "–ê–Ω—Ç–æ–Ω—ñ–Ω–∞ –û–Ω–∏—â—É–∫",
  "m.pohribna@pharmasco.com": "–ú–∞—Ä–∏–Ω–∞ –ü–æ–≥—Ä—ñ–±–Ω–∞",
  "s.kucherenko@pharmasco.com": "–°–Ω—ñ–∂–∞–Ω–∞ –ö—É—á–µ—Ä–µ–Ω–∫–æ"
};
const managerToEmployees = {
  "a.onischuk@pharmasco.com": ["m.pohribna@pharmasco.com", "s.kucherenko@pharmasco.com"]
};
const productList = [
  { code: "obj1", name: "Biossays 240 Plus" },
  { code: "obj2", name: "DH36" },
  { code: "obj3", name: "DF50" }
];

window.addEventListener("DOMContentLoaded", () => {
  const managerSelect = document.getElementById("managerSelect");
  const employeeSelect = document.getElementById("employeeSelect");
  const currentUser = document.getElementById("currentUser").textContent.trim();
  const dropdown = document.getElementById("productDropdown");
  const toggle = document.getElementById("dropdownToggle");
  const hiddenInput = document.getElementById("selectedProducts");
  const deadlineInput = document.getElementById("deadline");

  const currentManager = Object.keys(users).find(email => users[email] === currentUser);

  for (const [email, name] of Object.entries(users)) {
    if (managerToEmployees[email]) {
      const opt = new Option(name, email);
      managerSelect.add(opt);
    }
  }

  if (currentManager) {
    managerSelect.value = currentManager;
    managerSelect.disabled = true;
    const employees = managerToEmployees[currentManager];
    employeeSelect.innerHTML = '';
    employees.forEach(email => {
      const opt = new Option(users[email], email);
      employeeSelect.add(opt);
    });
  }

  managerSelect.addEventListener("change", () => {
    const selected = managerSelect.value;
    const employees = managerToEmployees[selected] || [];
    employeeSelect.innerHTML = '';
    employees.forEach(email => {
      const opt = new Option(users[email], email);
      employeeSelect.add(opt);
    });
  });

  productList.forEach(p => {
    const label = document.createElement("label");
    const input = document.createElement("input");
    input.type = "checkbox";
    input.value = p.code;
    input.dataset.name = p.name;
    label.appendChild(input);
    label.append(" " + p.name);
    dropdown.appendChild(label);
  });

  toggle.onclick = () => dropdown.classList.toggle("hidden");
  document.addEventListener("click", e => {
    if (!dropdown.contains(e.target) && e.target !== toggle) {
      dropdown.classList.add("hidden");
    }
  });

  dropdown.addEventListener("change", () => {
    const selected = [...dropdown.querySelectorAll("input:checked")];
    hiddenInput.value = selected.map(c => c.value).join(",");
    toggle.textContent = selected.length
      ? "–û–±—Ä–∞–Ω–æ: " + selected.map(c => c.dataset.name).join(", ")
      : "–û–±–µ—Ä—ñ—Ç—å –ø—Ä–æ–¥—É–∫—Ç–∏ ‚ñº";
  });

  const today = new Date();
  const deadline = new Date(today);
  deadline.setDate(deadline.getDate() + 14);
  deadlineInput.value = deadline.toISOString().split("T")[0];
});

document.getElementById("trainingForm").addEventListener("submit", e => {
  e.preventDefault();

  const skill = document.getElementById("skill").value;
  const managerEmail = document.getElementById("managerSelect").value;
  const employeeEmail = document.getElementById("employeeSelect").value;
  const managerName = users[managerEmail];
  const employeeName = users[employeeEmail];

  const today = new Date();
  const deadline = new Date(today); deadline.setDate(today.getDate() + 7);
  const dateStr = today.toLocaleDateString("uk-UA");
  const deadlineStr = deadline.toLocaleDateString("uk-UA");

  const selectedCodes = document.getElementById("selectedProducts").value.split(",").filter(Boolean);
  if (selectedCodes.length > 10) {
    alert("–ú–∞–∫—Å–∏–º—É–º 10 –ø—Ä–æ–¥—É–∫—Ç—ñ–≤!");
    return;
  }

  const links = selectedCodes.map(code => {
    const name = productList.find(p => p.code === code)?.name || code;
    return `üîπ https://gpavlik.github.io/farm_work/${code} (${name})`;
  }).join("\n");

  const subject = `–ù–∞–≤—á–∞–ª—å–Ω–µ –∑–∞–≤–¥–∞–Ω–Ω—è ${employeeName} –ø–æ –ü–í –≤—ñ–¥ ${dateStr}`;
  const body = `–®–∞–Ω–æ–≤–Ω–∞(–∏–π) ${employeeName},

–ü—Ä–æ—à—É –≤–∏–∫–æ–Ω–∞—Ç–∏ –¥–æ–º–∞—à–Ω—î –∑–∞–≤–¥–∞–Ω–Ω—è –∑ –Ω–∞–≤–∏–∫—É "${skill}" –¥–æ ${deadlineStr}.

–ú–∞—Ç–µ—Ä—ñ–∞–ª–∏:
https://gpavlik.github.io/farm_work/tr/–¢—Ä–µ–Ω—ñ–Ω–≥%20–¥–ª—è%20–Ω–æ–≤–∏—Ö%20—Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫—ñ–≤.pdf#page=11

–û–∑–Ω–∞–π–æ–º—Å—è —Ç–∞ –ø—ñ–¥–≥–æ—Ç—É–π 2 —Ü—ñ–ª—ñ –ø–æ SMART –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç–∏:
${links}

–ù–∞–¥—ñ—à–ª–∏ –¥–æ ${deadlineStr} –º–µ–Ω—ñ —Ç–∞ —É –∫–æ–ø—ñ—é ‚Äî –∫–µ—Ä—ñ–≤–Ω–∏–∫—É —Ç–∞ —Ç—Ä–µ–Ω–µ—Ä—É.

–ó –ø–æ–≤–∞–≥–æ—é,
${managerName}`;

  window.location.href =
    `mailto:${employeeEmail}?cc=${managerEmail},trainer@pharmasco.com,head@pharmasco.com`
    + `&subject=${encodeURIComponent(subject)}`
    + `&body=${encodeURIComponent(body)}`;
});
</script>
</body>
</html>
